<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OtoWoKoto - éŸ³å£°æ–‡å­—èµ·ã“ã—</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        /* è¨­å®šãƒœã‚¿ãƒ³ */
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            color: #666;
            width: auto;
            margin: 0;
        }
        .settings-btn:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 5px;
        }
        /* è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .settings-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            min-width: 200px;
        }
        .settings-menu.show {
            display: block;
        }
        .settings-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .settings-menu-item:last-child {
            border-bottom: none;
        }
        .settings-menu-item:hover {
            background: #f8f8f8;
        }
        .settings-menu-item span {
            font-size: 16px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #666;
            background: #f9f9f9;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .button-group button {
            flex: 1;
            margin-top: 0;
        }
        .btn-copy {
            background: #2196F3;
        }
        .btn-copy:hover {
            background: #1976D2;
        }
        .btn-download {
            background: #FF9800;
        }
        .btn-download:hover {
            background: #F57C00;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            display: none;
        }
        .result-content {
            white-space: pre-wrap;
            line-height: 1.6;
            background: white;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .warning {
            color: #856404;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ffeaa7;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .plan-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .plan-standard {
            background: #E3F2FD;
            color: #1976D2;
        }
        .plan-pro {
            background: #FFF3E0;
            color: #F57C00;
        }
        /* åˆ©ç”¨é‡è¡¨ç¤º */
        .usage-info {
            margin: 20px 0;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 1px solid #b3d9ff;
            display: none;
        }
        .usage-info h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }
        .usage-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .usage-stats-label {
            color: #666;
        }
        .usage-stats-value {
            font-weight: bold;
            color: #333;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .progress-fill.warning-bar {
            background: linear-gradient(90deg, #FF9800, #F57C00);
        }
        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
        <button class="settings-btn" id="settingsBtn" onclick="toggleSettingsMenu()">âš™ï¸</button>
        
        <!-- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-menu-item" onclick="openCustomerPortal()">
                <span>ğŸ’³</span>
                <span>ãƒ—ãƒ©ãƒ³ç®¡ç†</span>
            </div>
            <div class="settings-menu-item" onclick="openAddonCheckout()">
                <span>â•</span>
                <span>è¿½åŠ èª²é‡‘</span>
            </div>
            <div class="settings-menu-item" onclick="resetSettings()">
                <span>ğŸ”„</span>
                <span>è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</span>
            </div>
        </div>

        <h1>ğŸ¤ OtoWoKoto</h1>
        <p style="text-align: center; color: #666;">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æ–‡å­—èµ·ã“ã—</p>
        
        <label for="apiKey">APIã‚­ãƒ¼:</label>
        <input type="text" id="apiKey" value="test_token_pro_001" placeholder="test_token_pro_001">

        <!-- åˆ©ç”¨é‡è¡¨ç¤ºï¼ˆå®Ÿè¡Œå‰ã«è¡¨ç¤ºï¼‰ -->
        <div class="usage-info" id="usageInfo">
            <h3>ğŸ“Š åˆ©ç”¨çŠ¶æ³</h3>
            <div class="usage-stats">
                <span class="usage-stats-label">ãƒ—ãƒ©ãƒ³:</span>
                <span class="usage-stats-value" id="usagePlan">-</span>
            </div>
            <div class="usage-stats">
                <span class="usage-stats-label">æ®‹ã‚Šæ™‚é–“:</span>
                <span class="usage-stats-value" id="usageRemaining">-</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="usageProgress">0%</div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <p>ğŸ“ ã“ã“ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p style="font-size: 14px; color: #666;">ã¾ãŸã¯</p>
            <input type="file" id="fileInput" accept="audio/*" style="display: none;">
            <button type="button" onclick="document.getElementById('fileInput').click()" style="width: auto; padding: 8px 20px; background: #2196F3;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        </div>

        <div id="fileInfo" class="info-text"></div>
        
        <div class="warning" id="warningMsg"></div>

        <button id="transcribeBtn" disabled>æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>å‡¦ç†ä¸­... ãŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div class="error" id="errorMsg"></div>

        <div class="result" id="result">
            <h3>ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ<span id="planBadge"></span></h3>
            <div id="transcriptText" class="result-content"></div>
            
            <div class="button-group">
                <button onclick="copyToClipboard()" class="btn-copy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <div id="downloadLinkSection" style="display: none; margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; border: 1px solid #a5d6a7;">
                <p style="margin: 0 0 8px 0; font-size: 14px; color: #2e7d32;">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ60åˆ†ä»¥å†…ï¼‰</p>
                <a id="downloadLink" href="#" target="_blank" style="display: inline-block; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-size: 14px;">çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">âš ï¸ ã“ã®ãƒªãƒ³ã‚¯ã¯60åˆ†é–“ã®ã¿æœ‰åŠ¹ã§ã™</p>
            </div>
                <button onclick="downloadTranscript()" class="btn-download">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            
            <div id="summarySection" style="display: none; margin-top: 20px;">
                <h3>âœ¨ AIè¦ç´„ï¼ˆProãƒ—ãƒ©ãƒ³ï¼‰</h3>
                <div id="summaryText" class="result-content" style="background: #fff3cd;"></div>
                <div class="button-group">
                    <button onclick="copySummary()" class="btn-copy">ğŸ“‹ è¦ç´„ã‚’ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="downloadSummary()" class="btn-download">ğŸ’¾ è¦ç´„ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let usageData = null;
        // =========================================
        // å¤šè¨€èªå¯¾å¿œ
        // =========================================
        const LANGUAGES = {
            ja: {
                title: 'OtoWoKoto - éŸ³å£°æ–‡å­—èµ·ã“ã—',
                heading: 'ğŸ¤ OtoWoKoto',
                apiKeyLabel: 'APIã‚­ãƒ¼:',
                usageHeading: 'ğŸ“Š åˆ©ç”¨çŠ¶æ³',
                remainingLabel: 'æ®‹ã‚Šæ™‚é–“:',
                selectFile: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ',
                transcribeBtn: 'æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ',
                resultHeading: 'ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ',
                dropArea: 'ã“ã“ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—',
                dropOr: 'ã¾ãŸã¯',
                errNoApiKey: 'APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
                errNoFile: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„',
                warnOverage: (est, rem, over) => `âš ï¸ è­¦å‘Š: æ¨å®šå‡¦ç†æ™‚é–“ï¼ˆç´„${est}ç§’ï¼‰ãŒæ®‹ã‚Šæ™‚é–“ï¼ˆ${rem}ç§’ï¼‰ã‚’è¶…éã—ã¾ã™ã€‚ç´„${over}ç§’åˆ†ã®è¶…éãŒè¦‹è¾¼ã¾ã‚Œã¾ã™ã€‚`,
                warnLow: (est) => `âš ï¸ æ³¨æ„: æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ã¦ã„ã¾ã™ã€‚æ¨å®šå‡¦ç†æ™‚é–“: ç´„${est}ç§’`,
            },
            en: {
                title: 'OtoWoKoto - Voice Transcription',
                heading: 'ğŸ¤ OtoWoKoto',
                apiKeyLabel: 'API Key:',
                usageHeading: 'ğŸ“Š Usage',
                remainingLabel: 'Remaining:',
                selectFile: 'Select File',
                transcribeBtn: 'Transcribe',
                resultHeading: 'ğŸ“ Transcription Result',
                dropArea: 'Drop audio file here',
                dropOr: 'or',
                errNoApiKey: 'Please enter your API key',
                errNoFile: 'Please select a file',
                warnOverage: (est, rem, over) => `âš ï¸ Warning: Estimated time (${est}s) exceeds remaining (${rem}s) by ~${over}s.`,
                warnLow: (est) => `âš ï¸ Note: Remaining time is low. Estimated: ~${est}s`,
            }
        };

        // URLãƒ‘ã‚¹ã‹ã‚‰è¨€èªã‚’æ±ºå®šï¼ˆ/en â†’ enã€ãã‚Œä»¥å¤– â†’ jaï¼‰
        // ãƒ–ãƒ©ã‚¦ã‚¶è¨€èªè¨­å®šã‚‚è€ƒæ…®ï¼ˆãƒ‘ã‚¹ãªã—ã®å ´åˆï¼‰
        function detectLang() {
            const path = window.location.pathname;
            if (path === '/en' || path === '/en/') return 'en';
            if (path === '/ja' || path === '/ja/') return 'ja';
            // ãƒ‘ã‚¹ãªã—ã®å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨€èªã§è‡ªå‹•åˆ¤å®š
            return navigator.language.startsWith('ja') ? 'ja' : 'en';
        }

        const lang = detectLang();
        const L = LANGUAGES[lang];

        // è¨€èªã«å¿œã˜ã¦UIæ–‡è¨€ã‚’é©ç”¨
        function applyLang() {
            document.title = L.title;
            document.querySelector('h1').textContent = L.heading;
            document.querySelector('label[for="apiKey"]').textContent = L.apiKeyLabel;
            document.querySelector('#usageInfo h3').textContent = L.usageHeading;
            document.querySelector('.usage-stats-label').textContent = L.remainingLabel;
            document.querySelector('#transcribeBtn').textContent = L.transcribeBtn;
            document.querySelector('.upload-area p').textContent = L.dropArea;
            document.querySelector('.upload-area .info-text').textContent = L.dropOr;
            document.querySelector('button[onclick*="fileInput"]').textContent = L.selectFile;
        }

        document.addEventListener('DOMContentLoaded', applyLang);

        const SERVICE_URL = 'https://api.koto.otowolab.com';

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«APIã‚­ãƒ¼ã‹ã‚‰åˆ©ç”¨é‡ã‚’å–å¾—
        window.addEventListener('load', async function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                await fetchUsageInfo(apiKey);
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('settingsMenu');
                const btn = document.getElementById('settingsBtn');
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        });

        // è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        }

        // Stripe Customer Portal ã‚’é–‹ã
        async function openCustomerPortal() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`${SERVICE_URL}/api/customer-portal`, {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': apiKey
                    }
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    // Stripe Customer Portal ã¸é·ç§»
                    window.open(data.url, '_blank');
                } else {
                    alert('ãƒ—ãƒ©ãƒ³ç®¡ç†ç”»é¢ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + (data.detail || 'ã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }

            document.getElementById('settingsMenu').classList.remove('show');
        }

        // è¿½åŠ èª²é‡‘ Checkout ã‚’é–‹ã
        async function openAddonCheckout() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`${SERVICE_URL}/api/checkout/addon`, {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': apiKey
                    }
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    // Stripe Checkout ã¸é·ç§»
                    window.open(data.url, '_blank');
                } else {
                    alert('è¿½åŠ èª²é‡‘ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + (data.detail || 'ã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }

            document.getElementById('settingsMenu').classList.remove('show');
        }

        // è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetSettings() {
            if (confirm('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã¯APIã‚­ãƒ¼ã®ã¿ï¼‰')) {
                // å°†æ¥ã®æ‹¡å¼µç”¨ï¼ˆç¾åœ¨ã¯APIã‚­ãƒ¼ã®ã¿ï¼‰
                localStorage.clear();
                alert('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
            document.getElementById('settingsMenu').classList.remove('show');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                updateFileInfo();
                checkUsageBeforeTranscribe();
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            selectedFile = e.dataTransfer.files[0];
            updateFileInfo();
            checkUsageBeforeTranscribe();
        });

        function updateFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const sizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
            fileInfo.textContent = `é¸æŠ: ${selectedFile.name} (${sizeMB} MB)`;
        }

        // APIã‚­ãƒ¼å¤‰æ›´æ™‚ã«åˆ©ç”¨é‡ã‚’å–å¾—
        document.getElementById('apiKey').addEventListener('blur', async function() {
            const apiKey = this.value.trim();
            if (apiKey) {
                await fetchUsageInfo(apiKey);
                if (selectedFile) {
                    checkUsageBeforeTranscribe();
                }
            }
        });

        // åˆ©ç”¨é‡æƒ…å ±å–å¾—
        async function fetchUsageInfo(apiKey) {
            try {
                const response = await fetch(`${SERVICE_URL}/me`, {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': apiKey
                    }
                });

                if (response.ok) {
                    usageData = await response.json();
                    updateUsageDisplay(usageData);
                } else {
                    hideUsageDisplay();
                    usageData = null;
                }
            } catch (error) {
                console.error('Failed to fetch usage info:', error);
                hideUsageDisplay();
                usageData = null;
            }
        }

        // åˆ©ç”¨é‡è¡¨ç¤ºã‚’æ›´æ–°
        function updateUsageDisplay(data) {
            const usageInfo = document.getElementById('usageInfo');
            const planElement = document.getElementById('usagePlan');
            const remainingElement = document.getElementById('usageRemaining');
            const progressElement = document.getElementById('usageProgress');

            // ãƒ—ãƒ©ãƒ³è¡¨ç¤º
            const planType = data.plan_type || 'standard';
            planElement.textContent = planType === 'pro' ? 'Pro' : 'Standard';
            planElement.style.color = planType === 'pro' ? '#F57C00' : '#1976D2';

            // æ®‹ã‚Šæ™‚é–“è¡¨ç¤º
            const remaining = Math.floor(data.remaining_seconds || 0);
            const max = Math.floor(data.max_seconds_per_month || 0);
            const used = max - remaining;
            
            const remainingHours = Math.floor(remaining / 3600);
            const remainingMinutes = Math.floor((remaining % 3600) / 60);
            const remainingSeconds = remaining % 60;
            
            remainingElement.textContent = `${remaining.toLocaleString()}ç§’ / ${max.toLocaleString()}ç§’ (${remainingHours}h ${remainingMinutes}m ${remainingSeconds}s)`;

            // ä½¿ç”¨ç‡è¨ˆç®—
            const usagePercent = max > 0 ? ((used / max) * 100).toFixed(1) : 0;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            progressElement.style.width = `${usagePercent}%`;
            progressElement.textContent = `${usagePercent}%`;

            // è‰²åˆ†ã‘ï¼ˆä½¿ç”¨ç‡ã«å¿œã˜ã¦ï¼‰
            progressElement.classList.remove('warning-bar', 'danger');
            if (usagePercent >= 90) {
                progressElement.classList.add('danger');
            } else if (usagePercent >= 70) {
                progressElement.classList.add('warning-bar');
            }

            // è¡¨ç¤º
            usageInfo.style.display = 'block';
        }

        // åˆ©ç”¨é‡è¡¨ç¤ºã‚’éè¡¨ç¤º
        function hideUsageDisplay() {
            document.getElementById('usageInfo').style.display = 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«åˆ©ç”¨é‡ãƒã‚§ãƒƒã‚¯
        function checkUsageBeforeTranscribe() {
            const warningMsg = document.getElementById('warningMsg');
            const transcribeBtn = document.getElementById('transcribeBtn');
            
            if (!usageData || !selectedFile) {
                transcribeBtn.disabled = !selectedFile;
                warningMsg.style.display = 'none';
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‹ã‚‰æ¨å®šæ™‚é–“ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ï¼š1MB = 60ç§’ã¨ä»®å®šï¼‰
            const estimatedSeconds = Math.ceil((selectedFile.size / 1024 / 1024) * 60);
            const remaining = usageData.remaining_seconds || 0;

            if (estimatedSeconds > remaining) {
                // è¶…éè­¦å‘Š
                const overage = estimatedSeconds - remaining;
                warningMsg.textContent = L.warnOverage(estimatedSeconds, Math.floor(remaining), Math.floor(overage));
                warningMsg.style.display = 'block';
                transcribeBtn.disabled = false; // å®Ÿè¡Œã¯å¯èƒ½ï¼ˆè­¦å‘Šã®ã¿ï¼‰
            } else if (estimatedSeconds > remaining * 0.8) {
                // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªã„è­¦å‘Š
                warningMsg.textContent = L.warnLow(estimatedSeconds);
                warningMsg.style.display = 'block';
                transcribeBtn.disabled = false;
            } else {
                warningMsg.style.display = 'none';
                transcribeBtn.disabled = false;
            }
        }

        // æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ
        document.getElementById('transcribeBtn').addEventListener('click', async function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError(L.errNoApiKey);
                return;
            }
            if (!selectedFile) {
                showError(L.errNoFile);
                return;
            }

            this.disabled = true;
            document.getElementById('loading').style.display = 'block';
            hideError();
            document.getElementById('result').style.display = 'none';
            document.getElementById('warningMsg').style.display = 'none';

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
                const base64Audio = await fileToBase64(selectedFile);

                // APIå‘¼ã³å‡ºã—
                const response = await fetch(`${SERVICE_URL}/api/transcribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        job_id: `WEB-${Date.now()}`,
                        audio: {
                            data_base64: base64Audio.split(',')[1],
                            duration_sec: 60
                        },
                        options: {
                            language: 'ja',
                            speaker_diarization: false
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // æ–‡å­—èµ·ã“ã—çµæœ
                    document.getElementById('transcriptText').textContent = result.transcript;
                    document.getElementById('result').style.display = 'block';

                    // ãƒ—ãƒ©ãƒ³ãƒãƒƒã‚¸è¡¨ç¤º
                    const planType = result.plan_type || 'standard';
                    const planBadge = document.getElementById('planBadge');
                    planBadge.textContent = planType === 'pro' ? 'Pro' : 'Standard';
                    planBadge.className = `plan-badge plan-${planType}`;

                    // AIè¦ç´„ï¼ˆProãƒ—ãƒ©ãƒ³ã®å ´åˆï¼‰
                    if (result.derived_outputs && result.derived_outputs.summary) {
                        document.getElementById('summaryText').textContent = result.derived_outputs.summary;
                        document.getElementById('summarySection').style.display = 'block';
                    } else {
                        document.getElementById('summarySection').style.display = 'none';
                    }

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§å³æ™‚å‰Šé™¤ï¼‰
                    if (result.download_url) {
                        const fullDownloadUrl = `${SERVICE_URL}${result.download_url}`;
                        document.getElementById("downloadLink").href = fullDownloadUrl;
                        document.getElementById("downloadLinkSection").style.display = "block";
                    } else {
                        document.getElementById("downloadLinkSection").style.display = "none";
                    }

                    // åˆ©ç”¨é‡ã‚’å†å–å¾—
                    await fetchUsageInfo(apiKey);
                } else {
                    showError(result.error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }

            } catch (error) {
                showError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                this.disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        function copyToClipboard() {
            const text = document.getElementById('transcriptText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            });
        }

        function copySummary() {
            const text = document.getElementById('summaryText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('ğŸ“‹ è¦ç´„ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            });
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadTranscript() {
            const text = document.getElementById('transcriptText').textContent;
            const filename = `transcript_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            downloadTextFile(text, filename);
        }

        function downloadSummary() {
            const text = document.getElementById('summaryText').textContent;
            const filename = `summary_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            downloadTextFile(text, filename);
        }

        function downloadTextFile(text, filename) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
