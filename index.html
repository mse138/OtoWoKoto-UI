<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OtoWoKoto</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #0d1117;
      --surface:   #161b22;
      --surface2:  #1c2333;
      --border:    #2a3444;
      --teal:      #38d9c0;
      --teal-dim:  rgba(56,217,192,0.12);
      --teal-glow: rgba(56,217,192,0.35);
      --text:      #e6edf3;
      --text-muted:#7d8590;
      --warn:      #f0a83a;
      --danger:    #f05a5a;
      --radius:    14px;
      --radius-sm: 8px;
      --mono:      'DM Mono', monospace;
      --sans:      'Outfit', sans-serif;
      --transition: 0.22s cubic-bezier(0.4,0,0.2,1);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: 32px;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 4px;
    }
    .logo { display: flex; align-items: baseline; gap: 6px; }
    .logo-mark {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 500;
      color: var(--teal);
      letter-spacing: -0.5px;
    }
    .logo-sub { font-size: 11px; color: var(--text-muted); letter-spacing: 0.08em; font-weight: 300; }
    .menu-btn {
      background: none; border: none; cursor: pointer; color: var(--text-muted);
      padding: 6px; border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
      display: flex; flex-direction: column; gap: 4px; align-items: center;
    }
    .menu-btn span { display: block; width: 18px; height: 1.5px; background: currentColor; }
    .menu-btn:hover { color: var(--text); background: var(--surface2); }
    .menu-wrap { position: relative; }
    .dropdown {
      position: absolute; top: calc(100% + 6px); right: 0;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius); min-width: 180px; overflow: hidden;
      display: none; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .dropdown.open { display: block; animation: fadeIn 0.15s ease; }
    .dropdown a {
      display: block; padding: 11px 16px; font-size: 13px;
      color: var(--text-muted); text-decoration: none; cursor: pointer;
      transition: background var(--transition), color var(--transition);
      border-bottom: 1px solid var(--border);
    }
    .dropdown a:last-child { border-bottom: none; }
    .dropdown a:hover { background: var(--border); color: var(--text); }

    /* Tabs */
    .tabs {
      display: grid; grid-template-columns: 1fr 1fr;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 4px; gap: 4px;
    }
    .tab {
      padding: 9px; border: none; background: none;
      border-radius: calc(var(--radius) - 2px);
      font-family: var(--sans); font-size: 13px; font-weight: 500;
      color: var(--text-muted); cursor: pointer;
      transition: background var(--transition), color var(--transition);
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .tab.active { background: var(--teal-dim); color: var(--teal); box-shadow: inset 0 0 0 1px var(--teal-glow); }
    .tab:not(.active):hover { background: var(--surface2); color: var(--text); }

    /* Usage bar */
    .usage-bar-wrap {
      padding: 12px 16px; background: var(--surface);
      border: 1px solid var(--border); border-radius: var(--radius); display: none;
    }
    .usage-bar-wrap.visible { display: block; }
    .usage-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .usage-plan { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--teal); font-family: var(--mono); }
    .usage-time { font-size: 12px; font-family: var(--mono); color: var(--text-muted); }
    .usage-time.warn { color: var(--warn); }
    .usage-time.danger { color: var(--danger); }
    .bar-bg { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .bar-fill { height: 100%; background: var(--teal); border-radius: 2px; transition: width 0.6s ease, background 0.3s; }
    .bar-fill.warn { background: var(--warn); }
    .bar-fill.danger { background: var(--danger); }

    /* Messages */
    .msg { padding: 11px 14px; border-radius: var(--radius-sm); font-size: 13px; display: none; line-height: 1.5; }
    .msg.visible { display: block; }
    .msg.error { background: rgba(240,90,90,0.1); border: 1px solid rgba(240,90,90,0.3); color: #f09090; }
    .msg.warning { background: rgba(240,168,58,0.1); border: 1px solid rgba(240,168,58,0.3); color: var(--warn); }

    /* Drop Zone */
    .drop-zone {
      padding: 28px 20px; text-align: center; cursor: pointer;
      border: 1.5px dashed var(--border); border-radius: var(--radius);
      background: var(--surface); transition: border-color var(--transition), background var(--transition);
      position: relative;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--teal); background: var(--teal-dim); }
    .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .drop-icon {
      width: 44px; height: 44px; margin: 0 auto 12px; border-radius: 50%;
      background: var(--teal-dim); display: flex; align-items: center; justify-content: center;
      color: var(--teal); font-size: 20px;
    }
    .drop-label { font-size: 14px; color: var(--text-muted); line-height: 1.5; }
    .drop-label strong { color: var(--text); display: block; margin-bottom: 2px; }
    .file-selected {
      margin-top: 10px; font-family: var(--mono); font-size: 11px; color: var(--teal);
      background: var(--teal-dim); border-radius: 6px; padding: 5px 10px;
      display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* Record area */
    .record-area {
      padding: 28px 20px; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); display: flex; flex-direction: column; align-items: center; gap: 20px;
    }
    .waveform-wrap { width: 100%; height: 64px; }
    #waveCanvas { width: 100%; height: 100%; border-radius: var(--radius-sm); }
    .record-btn-wrap { position: relative; width: 80px; height: 80px; }
    .ripple {
      position: absolute; inset: -12px; border-radius: 50%;
      border: 1.5px solid var(--teal); opacity: 0;
    }
    .recording .ripple { animation: ripple 1.6s ease-out infinite; }
    .recording .ripple:nth-child(2) { animation-delay: 0.8s; }
    @keyframes ripple {
      0%   { transform: scale(0.85); opacity: 0.6; }
      100% { transform: scale(1.4);  opacity: 0; }
    }
    .record-btn {
      width: 80px; height: 80px; border-radius: 50%;
      border: 2px solid var(--border); background: var(--surface2);
      color: var(--text-muted); font-size: 28px; cursor: pointer;
      transition: all var(--transition);
      display: flex; align-items: center; justify-content: center;
      position: relative; z-index: 1;
    }
    .record-btn:hover:not(:disabled) { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); box-shadow: 0 0 24px var(--teal-glow); }
    .record-btn.recording { border-color: var(--danger); color: var(--danger); background: rgba(240,90,90,0.1); box-shadow: 0 0 24px rgba(240,90,90,0.3); }
    .timers { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .elapsed { font-family: var(--mono); font-size: 22px; font-weight: 400; color: var(--text); letter-spacing: 0.05em; }
    .countdown { font-family: var(--mono); font-size: 12px; color: var(--text-muted); letter-spacing: 0.04em; }
    .countdown.warn { color: var(--warn); }

    /* Submit btn */
    .submit-btn {
      width: 100%; padding: 14px; background: var(--teal); color: #0d1117;
      border: none; border-radius: var(--radius); font-family: var(--sans);
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: opacity var(--transition), box-shadow var(--transition), transform var(--transition);
      letter-spacing: 0.02em;
    }
    .submit-btn:hover:not(:disabled) { box-shadow: 0 0 28px var(--teal-glow); transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Status card */
    .status-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; display: none;
    }
    .status-card.visible { display: block; }
    .status-steps { display: flex; flex-direction: column; gap: 10px; }
    .step { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-muted); transition: color var(--transition); }
    .step.active { color: var(--text); }
    .step.done   { color: var(--teal); }
    .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: background var(--transition); }
    .step.active .step-dot { background: var(--text); animation: pulse 1s infinite; }
    .step.done  .step-dot  { background: var(--teal); }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.4); } }

    /* Result card */
    .result-card {
      background: var(--surface); border: 1px solid var(--teal-glow);
      border-radius: var(--radius); padding: 20px; display: none; animation: fadeIn 0.3s ease;
    }
    .result-card.visible { display: block; }
    .result-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
    .result-icon {
      width: 36px; height: 36px; border-radius: 50%; background: var(--teal-dim);
      display: flex; align-items: center; justify-content: center; color: var(--teal); font-size: 16px;
    }
    .result-title { font-size: 14px; font-weight: 600; color: var(--text); }
    .result-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .dl-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 12px; background: var(--teal-dim);
      border: 1px solid var(--teal-glow); border-radius: var(--radius-sm);
      color: var(--teal); font-family: var(--sans); font-size: 13px; font-weight: 600;
      text-decoration: none; cursor: pointer; transition: background var(--transition), box-shadow var(--transition);
    }
    .dl-btn:hover { background: rgba(56,217,192,0.2); box-shadow: 0 0 20px var(--teal-glow); }
    .result-note { margin-top: 10px; font-size: 11px; color: var(--text-muted); text-align: center; line-height: 1.5; }
    .again-btn {
      margin-top: 12px; width: 100%; padding: 10px; background: none;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--text-muted); font-family: var(--sans); font-size: 13px;
      cursor: pointer; transition: all var(--transition);
    }
    .again-btn:hover { border-color: var(--text-muted); color: var(--text); }

    /* Options */
    .option-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 11px 16px; cursor: pointer; user-select: none;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); transition: border-color var(--transition);
    }
    .option-toggle:hover { border-color: var(--teal); }
    .option-toggle-left { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; color: var(--text-muted); }
    .option-arrow { font-size: 11px; color: var(--text-muted); transition: transform var(--transition); font-family: var(--mono); }
    .option-arrow.open { transform: rotate(90deg); color: var(--teal); }
    .option-panel {
      display: none; background: var(--surface); border: 1px solid var(--border);
      border-top: none; border-radius: 0 0 var(--radius) var(--radius);
      padding: 16px; margin-top: -10px; padding-top: 20px;
    }
    .option-panel.open { display: block; animation: slideDown 0.2s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    .opt-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 9px 0; border-bottom: 1px solid var(--border);
    }
    .opt-row:last-child { border-bottom: none; }
    .opt-label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text); }
    .opt-label.muted { color: var(--text-muted); }
    .lock-icon { font-size: 10px; color: var(--text-muted); opacity: 0.6; }
    .toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle-track {
      position: absolute; inset: 0; background: var(--border);
      border-radius: 10px; cursor: pointer; transition: background var(--transition);
    }
    .toggle input:checked + .toggle-track { background: var(--teal); }
    .toggle-track::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 14px; height: 14px; background: white; border-radius: 50%;
      transition: transform var(--transition);
    }
    .toggle input:checked + .toggle-track::after { transform: translateX(16px); }
    .toggle input:disabled + .toggle-track { opacity: 0.35; cursor: not-allowed; }
    .radio-group { display: flex; gap: 6px; }
    .radio-opt {
      padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border);
      font-size: 11px; font-family: var(--mono); color: var(--text-muted);
      cursor: pointer; transition: all var(--transition);
    }
    .radio-opt.active { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); }
    .radio-opt.disabled { opacity: 0.35; cursor: not-allowed; }
    .opt-section-label {
      font-size: 10px; font-family: var(--mono); color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.1em; margin: 12px 0 8px;
    }
    .format-group { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .format-btn {
      padding: 8px; border-radius: var(--radius-sm); border: 1px solid var(--border);
      background: none; font-family: var(--sans); font-size: 12px; color: var(--text-muted);
      cursor: pointer; transition: all var(--transition); text-align: center;
    }
    .format-btn.active { border-color: var(--teal); color: var(--teal); background: var(--teal-dim); }
    .email-display {
      margin-top: 14px; padding: 10px 12px; background: var(--surface2);
      border-radius: var(--radius-sm); border: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .email-display span { font-size: 11px; font-family: var(--mono); color: var(--text-muted); }
    .email-display .email-val { color: var(--text); font-size: 12px; }

    /* ===== fileModeã‚’ç¸¦ã„ã£ã±ã„ã«ä½¿ã† ===== */
    #fileMode {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 340px;   /* â† ã“ã“ã§å…¨ä½“ã®æœ€ä½é«˜ã•ã‚’åº•ä¸Šã’ */
    }
    /* drop-zoneã‚’å¯èƒ½ãªé™ã‚Šåºƒã’ã‚‹ */
    .drop-zone {
      flex: 1;
      min-height: 240px;   /* æœ€ä½é™ã“ã‚Œã ã‘ã¯ç¢ºä¿ */
    }
    /* record-areaã‚‚æƒãˆã‚‹ */
    .record-area {
      min-height: 340px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    footer { text-align: center; font-size: 11px; font-family: var(--mono); color: var(--text-muted); opacity: 0.5; padding-top: 4px; }
  </style>
</head>
<body>
<div class="app">

  <header>
    <div class="logo">
      <span class="logo-mark">OtoWoKoto</span>
      <span class="logo-sub">by otowolab</span>
    </div>
    <div class="menu-wrap">
      <button class="menu-btn" id="menuBtn">
        <span></span><span></span><span></span>
      </button>
      <div class="dropdown" id="dropdown">
        <a id="menuPortal">ğŸ“‹ ãƒ—ãƒ©ãƒ³ç®¡ç†</a>
        <a id="menuAddon">â• è¿½åŠ è³¼å…¥</a>
        <a id="menuAbout">â„¹ï¸ about</a>
        <a id="menuReset">ğŸ”„ è¨­å®šãƒªã‚»ãƒƒãƒˆ</a>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tabFile">ğŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</button>
    <button class="tab" id="tabLive">ğŸ™ï¸ ãƒ©ã‚¤ãƒ–éŒ²éŸ³</button>
  </div>

  <div class="msg error" id="msgError"></div>
  <div class="msg warning" id="msgWarn"></div>

  <!-- File mode -->
  <div id="fileMode">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept="audio/*,video/*">
      <div class="drop-icon">ğŸµ</div>
      <div class="drop-label">
        <strong>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</strong>
        ã¾ãŸã¯ ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ
      </div>
      <div class="file-selected" id="fileName" style="display:none"></div>
    </div>
    <button class="submit-btn" id="submitBtn" style="margin-top:0; flex-shrink:0;" disabled>æ–‡å­—èµ·ã“ã—</button>
  </div>

  <!-- Live mode -->
  <div id="liveMode" style="display:none">
    <div class="record-area">
      <div class="waveform-wrap">
        <canvas id="waveCanvas"></canvas>
      </div>
      <div class="record-btn-wrap" id="recordBtnWrap">
        <div class="ripple"></div>
        <div class="ripple"></div>
        <button class="record-btn" id="recordBtn">ğŸ™ï¸</button>
      </div>
      <div class="timers">
        <div class="elapsed" id="elapsed">00:00:00</div>
        <div class="countdown" id="countdown">æ®‹ã‚Š â€”</div>
      </div>
    </div>
  </div>


  <!-- Processing -->
  <div class="status-card" id="statusCard">
    <div class="status-steps">
      <div class="step" id="step1"><div class="step-dot"></div>éŸ³å£°ã‚’è§£æä¸­</div>
      <div class="step" id="step2"><div class="step-dot"></div>æ–‡å­—èµ·ã“ã—å‡¦ç†</div>
      <div class="step" id="step3"><div class="step-dot"></div>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</div>
      <div class="step" id="step4"><div class="step-dot"></div>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</div>
    </div>
  </div>

  <!-- Result -->
  <div class="result-card" id="resultCard">
    <div class="result-header">
      <div class="result-icon">âœ…</div>
      <div>
        <div class="result-title">å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
        <div class="result-sub">ãƒ¡ãƒ¼ãƒ«ã«DLãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>
      </div>
    </div>
    <a class="dl-btn" id="dlBtn" download>â¬‡ï¸ çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <p class="result-note">æœ‰åŠ¹æœŸé™: <strong>60åˆ†</strong> ï¼ DLå¾Œã«è‡ªå‹•å‰Šé™¤</p>
    <button class="again-btn" id="againBtn">ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã™ã‚‹</button>
  </div>

  <!-- Options -->
  <div>
    <div class="option-toggle" id="optToggle">
      <div class="option-toggle-left"><span>âš™ï¸</span><span>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</span></div>
      <span class="option-arrow" id="optArrow">â€º</span>
    </div>
    <div class="option-panel" id="optPanel">
      <div class="opt-row">
        <span class="opt-label">æ–‡å­—èµ·ã“ã—å…¨æ–‡</span>
        <label class="toggle"><input type="checkbox" id="optTranscript" checked><div class="toggle-track"></div></label>
      </div>
      <div class="opt-row">
        <span class="opt-label">è¦ç´„</span>
        <label class="toggle"><input type="checkbox" id="optSummary"><div class="toggle-track"></div></label>
      </div>
      <div class="opt-row" id="rowDepth" style="opacity:0.4">
        <span class="opt-label muted">è¦ç´„æ·±åº¦ <span class="lock-icon">ğŸ”’</span></span>
        <div class="radio-group">
          <div class="radio-opt disabled">ç°¡æ½”</div>
          <div class="radio-opt active disabled">æ¨™æº–</div>
          <div class="radio-opt disabled">è©³ç´°</div>
        </div>
      </div>
      <div class="opt-row">
        <span class="opt-label">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span>
        <label class="toggle"><input type="checkbox" id="optTimestamp"><div class="toggle-track"></div></label>
      </div>
      <div class="opt-row" id="rowStructure" style="opacity:0.4">
        <span class="opt-label muted">æ§‹æˆå‡ºåŠ› <span class="lock-icon">ğŸ”’</span></span>
        <label class="toggle"><input type="checkbox" id="optStructure" disabled><div class="toggle-track"></div></label>
      </div>
      <div class="opt-row" id="rowDiarize" style="opacity:0.4">
        <span class="opt-label muted">è©±è€…åˆ†ã‘ <span class="lock-icon">ğŸ”’</span></span>
        <label class="toggle"><input type="checkbox" id="optDiarize" disabled><div class="toggle-track"></div></label>
      </div>
      <div class="opt-row" id="rowTranslate" style="opacity:0.4">
        <span class="opt-label muted">ç¿»è¨³ <span class="lock-icon">ğŸ”’</span></span>
        <label class="toggle"><input type="checkbox" id="optTranslate" disabled><div class="toggle-track"></div></label>
      </div>
      <div class="opt-section-label">å‡ºåŠ›å½¢å¼</div>
      <div class="format-group">
        <button class="format-btn active" id="fmtText">ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆ</button>
        <button class="format-btn" id="fmtReport">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ</button>
      </div>
      <div class="email-display">
        <span>ğŸ“§</span>
        <span class="email-val" id="emailDisplay">â€”</span>
      </div>
    </div>
  </div>

  <div class="usage-bar-wrap" id="usageBar">
    <div class="usage-row">
      <span class="usage-plan" id="usagePlan">â€”</span>
      <span class="usage-time" id="usageTime">â€”</span>
    </div>
    <div class="bar-bg"><div class="bar-fill" id="barFill" style="width:0%"></div></div>
  </div>
  <footer style="display:none">otowolab.com</footer>
</div>

<script>
const SERVICE_URL = 'https://api.koto.otowolab.com';
let apiKey = new URLSearchParams(window.location.search).get('key') || '';
let selectedFile = null;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let elapsedSec = 0;
let elapsedTimer = null;
let waveAnimFrame = null;
let analyser = null;
let audioCtx = null;
let usageData = null;
let currentFormat = 'text';
let activeTab = 'file';
let stepTimer = null;

document.addEventListener('DOMContentLoaded', () => {
  // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã¨ãƒ©ã‚¤ãƒ–éŒ²éŸ³ã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’åŒæœŸ

  initMenu();
  initTabs();
  initDropZone();
  initOptions();
  initRecordBtn();
  document.getElementById('submitBtn').addEventListener('click', runTranscribe);
  document.getElementById('againBtn').addEventListener('click', resetUI);
  if (apiKey) fetchUsage();
});

// Menu
function initMenu() {
  const btn = document.getElementById('menuBtn');
  const dd  = document.getElementById('dropdown');
  btn.addEventListener('click', e => { e.stopPropagation(); dd.classList.toggle('open'); });
  document.addEventListener('click', () => dd.classList.remove('open'));
  document.getElementById('menuPortal').addEventListener('click', openPortal);
  document.getElementById('menuAddon').addEventListener('click', openAddon);
  document.getElementById('menuAbout').addEventListener('click', () => alert('OtoWoKoto\nZero Retention Voice Transcription\nby otowolab.com'));
  document.getElementById('menuReset').addEventListener('click', () => { if(confirm('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) location.href = location.pathname; });
}

async function openPortal() {
  if (!apiKey) return showError('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  try { const r = await apiFetch('/api/customer-portal'); if(r.url) window.open(r.url,'_blank'); } catch(e) { showError('ãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'); }
}
async function openAddon() {
  if (!apiKey) return showError('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  try { const r = await apiFetch('/api/checkout/addon'); if(r.url) window.open(r.url,'_blank'); } catch(e) { showError('è¿½åŠ è³¼å…¥ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'); }
}

// Tabs
function initTabs() {
  document.getElementById('tabFile').addEventListener('click', () => switchTab('file'));
  document.getElementById('tabLive').addEventListener('click', () => switchTab('live'));
}
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tabFile').classList.toggle('active', tab==='file');
  document.getElementById('tabLive').classList.toggle('active', tab==='live');
  document.getElementById('fileMode').style.display = tab==='file' ? '' : 'none';
  document.getElementById('liveMode').style.display = tab==='live' ? '' : 'none';
  updateSubmitBtn();
  hideMessages();
}

// Drop zone
function initDropZone() {
  const zone  = document.getElementById('dropZone');
  const input = document.getElementById('fileInput');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if(e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]); });
  input.addEventListener('change', () => { if(input.files[0]) setFile(input.files[0]); });
}
function setFile(f) {
  selectedFile = f;
  const el = document.getElementById('fileName');
  el.textContent = f.name; el.style.display = 'inline-block';
  updateSubmitBtn(); hideMessages();
  // æ®‹ã‚Šæ™‚é–“0ã®ãƒã‚§ãƒƒã‚¯
  if (usageData && usageData.remaining_seconds <= 0) {
    showError('ä»Šæœˆã®åˆ©ç”¨æ™‚é–“ãŒä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚è¿½åŠ è³¼å…¥ã¾ãŸã¯ãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚');
    document.getElementById('submitBtn').disabled = true;
  }
}

// Live Recording
function initRecordBtn() {
  document.getElementById('recordBtn').addEventListener('click', toggleRecord);
  drawIdleWave();
}
async function toggleRecord() {
  if (!isRecording) await startRecord(); else await stopRecord();
}
async function startRecord() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    audioCtx.createMediaStreamSource(stream).connect(analyser);
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.start(100);
    isRecording = true; elapsedSec = 0;
    const btn = document.getElementById('recordBtn');
    btn.textContent = 'â¹ï¸'; btn.classList.add('recording');
    document.getElementById('recordBtnWrap').classList.add('recording');
    document.getElementById('submitBtn').disabled = true;
    elapsedTimer = setInterval(() => { elapsedSec++; updateTimers(); }, 1000);
    drawLiveWave();
  } catch(e) { showError('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ'); }
}
async function stopRecord() {
  return new Promise(resolve => {
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      selectedFile = new File([blob], `rec_${Date.now()}.webm`, { type: 'audio/webm' });
      resolve();
    };
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t => t.stop());
    isRecording = false;
    clearInterval(elapsedTimer);
    cancelAnimationFrame(waveAnimFrame);
    const btn = document.getElementById('recordBtn');
    btn.textContent = 'ğŸ™ï¸'; btn.classList.remove('recording');
    document.getElementById('recordBtnWrap').classList.remove('recording');
    drawIdleWave(); updateSubmitBtn();
  });
}
function updateTimers() {
  const fmt = s => [Math.floor(s/3600),Math.floor((s%3600)/60),s%60].map(n=>String(n).padStart(2,'0')).join(':');
  document.getElementById('elapsed').textContent = fmt(elapsedSec);
  if (usageData) {
    const rem = Math.max(0, Math.floor(usageData.remaining_seconds) - elapsedSec);
    const el = document.getElementById('countdown');
    el.textContent = `æ®‹ã‚Š ${fmt(rem)}`;
    el.className = 'countdown' + (rem < 300 ? ' warn' : '');
  }
}
function drawIdleWave() {
  const canvas = document.getElementById('waveCanvas');
  if (!canvas.offsetWidth) return;
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * devicePixelRatio;
  canvas.height = canvas.offsetHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const w = canvas.offsetWidth, h = canvas.offsetHeight;
  let t = 0;
  function draw() {
    if (isRecording) return;
    ctx.clearRect(0,0,w,h);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(56,217,192,0.25)';
    ctx.lineWidth = 1.5;
    for (let x=0; x<w; x++) {
      const y = h/2 + Math.sin((x/w)*Math.PI*4+t)*6*Math.sin(x/w*Math.PI);
      x===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
    t += 0.04;
    waveAnimFrame = requestAnimationFrame(draw);
  }
  cancelAnimationFrame(waveAnimFrame);
  draw();
}
function drawLiveWave() {
  const canvas = document.getElementById('waveCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * devicePixelRatio;
  canvas.height = canvas.offsetHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const w = canvas.offsetWidth, h = canvas.offsetHeight;
  const data = new Uint8Array(analyser.frequencyBinCount);
  function draw() {
    if (!isRecording) return;
    analyser.getByteTimeDomainData(data);
    ctx.clearRect(0,0,w,h);
    ctx.beginPath();
    ctx.strokeStyle = '#38d9c0';
    ctx.lineWidth = 1.5;
    const step = w / data.length;
    data.forEach((v,i) => { const x=i*step, y=(v/128)*h/2; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
    ctx.stroke();
    waveAnimFrame = requestAnimationFrame(draw);
  }
  cancelAnimationFrame(waveAnimFrame);
  draw();
}

// Options
function initOptions() {
  document.getElementById('optToggle').addEventListener('click', () => {
    document.getElementById('optPanel').classList.toggle('open');
    document.getElementById('optArrow').classList.toggle('open');
  });
  document.getElementById('fmtText').addEventListener('click', () => setFormat('text'));
  document.getElementById('fmtReport').addEventListener('click', () => setFormat('report'));
}
function setFormat(fmt) {
  currentFormat = fmt;
  document.getElementById('fmtText').classList.toggle('active', fmt==='text');
  document.getElementById('fmtReport').classList.toggle('active', fmt==='report');
}

// Usage
async function fetchUsage() {
  try {
    const d = await apiFetch('/me');
    usageData = d;
    updateUsageBar();
    updateProOptions();
    document.getElementById('emailDisplay').textContent = d.email || 'â€”';
  } catch(e) {}
}
function updateUsageBar() {
  if (!usageData) return;
  document.getElementById('usageBar').classList.add('visible');
  const max = usageData.max_seconds_per_month || 1;
  const rem = usageData.remaining_seconds || 0;
  const pct = Math.min(100, ((max-rem)/max)*100);
  const h = Math.floor(rem/3600), m = Math.floor((rem%3600)/60);
  document.getElementById('usagePlan').textContent = (usageData.plan_type||'standard').toUpperCase();
  const timeEl = document.getElementById('usageTime');
  timeEl.textContent = `æ®‹ ${h}h ${m}m`;
  const fill = document.getElementById('barFill');
  fill.style.width = pct + '%';
  fill.className = 'bar-fill' + (pct>=90?' danger':pct>=70?' warn':'');
  timeEl.className = 'usage-time' + (pct>=90?' danger':pct>=70?' warn':'');
}
function updateProOptions() {
  if (!usageData || usageData.plan_type !== 'pro') return;
  ['rowDepth','rowStructure','rowDiarize','rowTranslate'].forEach(id => {
    const el = document.getElementById(id);
    el.style.opacity = '1';
    el.querySelectorAll('input').forEach(i => i.disabled = false);
    el.querySelectorAll('.radio-opt,.format-btn').forEach(i => i.classList.remove('disabled'));
  });
}

// Submit
function updateSubmitBtn() {
  document.getElementById('submitBtn').disabled = !selectedFile;
}

async function runTranscribe() {
  if (!selectedFile) return;
  if (!apiKey) return showError('URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆAPIã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰');
  hideMessages();
  setUIState('processing');
  try {
    const base64   = await fileToBase64(selectedFile);
    const duration = await getAudioDuration(selectedFile);
    const body = {
      job_id: `WEB-${Date.now()}`,
      audio: { data_base64: base64.split(',')[1], duration_sec: duration },
      options: { language: 'ja', speaker_diarization: document.getElementById('optDiarize')?.checked || false }
    };
    animateSteps();
    const result = await apiFetch('/api/transcribe', { method:'POST', body: JSON.stringify(body) });
    if (result.success) {
      setUIState('done');
      if (result.download_url) {
        const dl = document.getElementById('dlBtn');
        dl.href = `${SERVICE_URL}${result.download_url}`;
        dl.style.display = 'flex';
      } else {
        document.getElementById('dlBtn').style.display = 'none';
      }
      fetchUsage();
    } else {
      setUIState('idle');
      showError(result.error?.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  } catch(e) { setUIState('idle'); showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
}

function animateSteps() {
  const steps = ['step1','step2','step3','step4'];
  let i = 0;
  steps.forEach(s => { const el=document.getElementById(s); el.classList.remove('active','done'); });
  document.getElementById('step1').classList.add('active');
  stepTimer = setInterval(() => {
    if (i < steps.length-1) {
      document.getElementById(steps[i]).classList.replace('active','done');
      i++;
      document.getElementById(steps[i]).classList.add('active');
    }
  }, 2500);
}

function setUIState(state) {
  const statusCard = document.getElementById('statusCard');
  const resultCard = document.getElementById('resultCard');
  const submitBtn  = document.getElementById('submitBtn');
  statusCard.classList.remove('visible');
  resultCard.classList.remove('visible');
  if (state === 'processing') {
    submitBtn.disabled = true;
    document.getElementById('fileMode').style.display = 'none';
    document.getElementById('liveMode').style.display = 'none';
    statusCard.classList.add('visible');
  } else if (state === 'done') {
    clearInterval(stepTimer);
    ['step1','step2','step3','step4'].forEach(s => {
      const el = document.getElementById(s);
      el.classList.remove('active'); el.classList.add('done');
    });
    setTimeout(() => { statusCard.classList.remove('visible'); resultCard.classList.add('visible'); }, 600);
  } else {
    submitBtn.disabled = !selectedFile;
    document.getElementById('fileMode').style.display = activeTab==='file' ? '' : 'none';
    document.getElementById('liveMode').style.display = activeTab==='live' ? '' : 'none';
  }
}

function resetUI() {
  selectedFile = null;
  document.getElementById('fileName').style.display = 'none';
  document.getElementById('fileInput').value = '';
  setUIState('idle');
  updateSubmitBtn();
  hideMessages();
}

// Helpers
async function apiFetch(path, opts={}) {
  const res = await fetch(`${SERVICE_URL}${path}`, {
    ...opts,
    headers: { 'Content-Type':'application/json', 'X-API-KEY': apiKey, ...(opts.headers||{}) }
  });
  return res.json();
}
function fileToBase64(file) {
  return new Promise((res,rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function getAudioDuration(file) {
  return new Promise(res => {
    const a = new Audio();
    a.src = URL.createObjectURL(file);
    a.onloadedmetadata = () => { URL.revokeObjectURL(a.src); res(isFinite(a.duration)?a.duration:60); };
    a.onerror = () => res(60);
  });
}
function showError(msg) { const el=document.getElementById('msgError'); el.textContent=msg; el.classList.add('visible'); }
function showWarn(msg)  { const el=document.getElementById('msgWarn');  el.textContent=msg; el.classList.add('visible'); }
function hideMessages() { document.getElementById('msgError').classList.remove('visible'); document.getElementById('msgWarn').classList.remove('visible'); }
</script>
</body>
</html>
